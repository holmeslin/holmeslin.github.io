<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>關於 Web 跨域相關紀錄 - Feng-Chi&#39;s Note-Take</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content=Feng-Chi><meta name=description content="前言 前段時間公司同事出現了跨域問題 , 雖然我知道了大略的解決方案 , 但是說實在的真實真實的跨域知識及領域 ,
不是了解得很透徹 , 趁這個機會好好查一下文章記錄下來"><meta name=keywords content=CORS><meta name=generator content="Hugo 0.57.2 with theme even"><link rel=canonical href=https://holmeslin.github.io/post/2020/07/cross-domain/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.6eb09ed45a88bd339269c14515d2a11f2e0afdadbdd763d83f9b5c797166b081.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property=og:title content="關於 Web 跨域相關紀錄"><meta property=og:description content="前言

前段時間公司同事出現了跨域問題 , 雖然我知道了大略的解決方案 , 但是說實在的真實真實的跨域知識及領域 ,

不是了解得很透徹 , 趁這個機會好好查一下文章記錄下來"><meta property=og:type content=article><meta property=og:url content=https://holmeslin.github.io/post/2020/07/cross-domain/><meta property=article:published_time content=2020-07-14T08:51:19+08:00><meta property=article:modified_time content=2020-07-14T08:51:19+08:00><meta itemprop=name content="關於 Web 跨域相關紀錄"><meta itemprop=description content="前言

前段時間公司同事出現了跨域問題 , 雖然我知道了大略的解決方案 , 但是說實在的真實真實的跨域知識及領域 ,

不是了解得很透徹 , 趁這個機會好好查一下文章記錄下來"><meta itemprop=datePublished content=2020-07-14T08:51:19&#43;08:00><meta itemprop=dateModified content=2020-07-14T08:51:19&#43;08:00><meta itemprop=wordCount content=4057><meta itemprop=keywords content=CORS,web,><meta name=twitter:card content=summary><meta name=twitter:title content="關於 Web 跨域相關紀錄"><meta name=twitter:description content="前言

前段時間公司同事出現了跨域問題 , 雖然我知道了大略的解決方案 , 但是說實在的真實真實的跨域知識及領域 ,

不是了解得很透徹 , 趁這個機會好好查一下文章記錄下來"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Feng-Chi</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Feng-Chi</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>關於 Web 跨域相關紀錄</h1><div class=post-meta><span class=post-time>2020-07-14</span><div class=post-category><a href=/categories/%E7%B4%80%E9%8C%84/>紀錄</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目錄</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#1-什麼是跨域>1. 什麼是跨域</a></li><li><a href=#2-瀏覽器的同源>2. 瀏覽器的同源</a></li><li><a href=#3-如何解決>3. 如何解決</a><ul><li><a href=#3-1-jsonp>3.1. JSONP</a><ul><li><a href=#3-1-1-jsonp-原理>3.1.1. JSONP 原理</a></li><li><a href=#3-1-2-如何實現>3.1.2. 如何實現</a></li><li><a href=#3-1-3-jsonp-vs-ajax>3.1.3. JSONP VS AJAX</a></li></ul></li><li><a href=#3-2-cors>3.2. CORS</a><ul><li><a href=#3-2-1-間單請求>3.2.1. 間單請求</a></li><li><a href=#3-2-2-複雜請求>3.2.2. 複雜請求</a></li></ul></li><li><a href=#3-3-postmessage>3.3. postMessage</a></li><li><a href=#3-4-webscoket>3.4. WebScoket</a></li><li><a href=#3-5-nginx-反向代理>3.5. Nginx 反向代理</a></li><li><a href=#3-6-window-name-iframe>3.6. window.name + iframe</a></li><li><a href=#3-7-location-hash-iframe>3.7. location.hash + iframe</a></li><li><a href=#3-8-document-domain-iframe>3.8. document.domain + iframe</a></li></ul></li><li><a href=#4-参考文章>4. 参考文章</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=前言>前言</h2><p>前段時間公司同事出現了跨域問題 , 雖然我知道了大略的解決方案 , 但是說實在的真實真實的跨域知識及領域 ,</p><p>不是了解得很透徹 , 趁這個機會好好查一下文章記錄下來</p><h2 id=1-什麼是跨域>1. 什麼是跨域</h2><p>跨域簡單的說是指一個網域下的網頁或腳本想要去請求另一個網域下的資源 ,</p><p>而我們的跨域 , 大都是指瀏覽器基於同源政策限制下產生問題</p><h2 id=2-瀏覽器的同源>2. 瀏覽器的同源</h2><p>同源策略/SOP（Same origin policy）是一種協定，由 <code>Netscape</code> 公司 <code>1995</code> 年引入瀏覽器，它是瀏覽器最核心也最基本的安全功能，如果缺少了同源策略，瀏覽器很容易受到 <code>XSS</code> 、<code>CSFR</code> 等攻擊</p><p>同源，什麼是源呢？源指的是 <code>協議</code>、<code>域名</code>、<code>端口</code>，那麼同源即三者相同，即便是不同的域名指向同一個 IP 位址，也不同源</p><p>以 <code>http://www.example.com:80/dir/page.html</code> 這一個網址來說</p><ul><li><code>http://</code> &ndash;&gt; <code>協議</code></li><li><code>www</code> &ndash;&gt; <code>子域名</code></li><li><code>example.com</code> &ndash;&gt; <code>主域名</code></li><li><code>80</code> &ndash;&gt; <code>端口</code></li><li><code>/dir/page.html</code> &ndash;&gt; 請求資源位置</li></ul><p>如果像下面網址請求的同源狀況</p><blockquote><ul><li><a href=http://www.example.com/dir2/other.html>http://www.example.com/dir2/other.html</a> &mdash;&gt; <code>同源</code></li><li><a href=http://example.com/dir/other.html>http://example.com/dir/other.html</a> &ndash;&gt; <code>不同源（域名不同）</code></li><li><a href=http://v2.www.example.com/dir/other.html>http://v2.www.example.com/dir/other.html</a> &ndash;&gt; <code>不同源（域名不同）</code></li><li><a href=https://www.example.com/dir/other.html>https://www.example.com/dir/other.html</a> &ndash;&gt; <code>不同源（協議不同）</code></li><li><a href=http://www.example.com:81/dir/other.html>http://www.example.com:81/dir/other.html</a> &ndash;&gt; <code>不同源（端口不同）</code></li></ul></blockquote><p>如有以上情境 , 瀏覽器將會限制我們以下限制</p><blockquote><ul><li>Cookie、LocalStorage 和 IndexDB 無法讀取。</li><li>DOM 無法獲得。</li><li>AJAX 請求不能發送。</li></ul></blockquote><h2 id=3-如何解決>3. 如何解決</h2><h3 id=3-1-jsonp>3.1. JSONP</h3><h4 id=3-1-1-jsonp-原理>3.1.1. JSONP 原理</h4><p>假如有兩的不同域名的資源 a.html 和 b.js</p><p>a.html</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>test<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://www.example2.com/b.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span> <span class=c1>// Hello~~
</span><span class=c1></span>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>b.js</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript><span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=s1>&#39;Hello~~&#39;</span>
</code></pre></td></tr></table></div></div><p>由這一個例子來講 , 我們可以了解 <code>&lt;script&gt;</code> 這個標籤的 <code>scr</code> 的屬性是不被同源政策所限制 ,</p><p>所以這就是 <code>JSONP</code> 的核心原理</p><h4 id=3-1-2-如何實現>3.1.2. 如何實現</h4><ul><li>CallBack</li></ul><p>a.html : <a href=http://www.example.com/a.html>http://www.example.com/a.html</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>  <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://www.example2.com/b.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>

  <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span><span class=p>&gt;</span>
    <span class=kd>function</span> <span class=nx>cb</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>b</span><span class=p>)</span> <span class=c1>// 我是b
</span><span class=c1></span>    <span class=p>}</span>
  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>b.js : <a href=http://www.example2.com/b.js>http://www.example2.com/b.js</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript>  <span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=s1>&#39;我是b&#39;</span>
  <span class=c1>// 調用 cb 函數，並以 json 數據形式做參數
</span><span class=c1></span>  <span class=nx>cb</span><span class=p>({</span>
    <span class=nx>code</span><span class=o>:</span> <span class=mi>200</span><span class=p>,</span>
    <span class=nx>msg</span><span class=o>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span>
    <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
      <span class=nx>b</span><span class=o>:</span> <span class=nx>b</span><span class=p>,</span>
    <span class=p>},</span>
  <span class=p>})</span>
</code></pre></td></tr></table></div></div><p>創建一個回調函數，然後在遠程服務上調用這個函數並且將 <code>JSON</code> 數據形式作為參數傳遞，完成回調，就是 <code>JSONP</code> 的簡單實現模式，或者說是 <code>JSONP</code> 的原型，是不是很簡單呢</p><p>將 <code>JSON</code> 數據填充進回調函數，現在懂為什麼 <code>JSONP</code> 叫 <code>JSON with Padding</code> 了吧</p><p>上面這種實現很簡單，通常情況下，我們希望這個 <code>script</code> 標籤能夠動態的調用，而不是像上面因為固定在 <code>HTML</code> 裡面加載時直接執行了，很不靈活，我們可以通過 <code>javascript</code> 動態的創建 <code>script</code> 標籤，這樣我們就可以靈活調用遠程服務了，那麼我們簡單改造下<code>頁面 a</code> 如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>  <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span><span class=p>&gt;</span>
    <span class=kd>function</span> <span class=nx>cb</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>b</span><span class=p>)</span> <span class=c1>// 我是b
</span><span class=c1></span>    <span class=p>}</span>

    <span class=c1>// 動態添加 &lt;script&gt;
</span><span class=c1></span>    <span class=kd>function</span> <span class=nx>addScriptTag</span><span class=p>(</span><span class=nx>src</span><span class=p>)</span> <span class=p>{</span>
      <span class=kd>let</span> <span class=nx>script</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;script&#39;</span><span class=p>)</span>
      <span class=nx>script</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>,</span> <span class=s1>&#39;text/javascript&#39;</span><span class=p>)</span>
      <span class=nx>script</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>src</span>
      <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>script</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nb>window</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
      <span class=nx>addScriptTag</span><span class=p>(</span><span class=s1>&#39;http://www.example2.com/b.js&#39;</span><span class=p>)</span>
    <span class=p>}</span>
  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>如上所示，只是些基礎操作，就不解釋了，現在我們就可以優雅的控制執行了，再想調用一個遠程服務的話，只要添加 <code>addScriptTag</code> 方法，傳入遠程服務的 <code>src</code> 值就可以</p><p>接下來我們就可以愉快的進行一次真正意義上的 <code>JSONP</code> 服務調取了</p><p>我們使用 <code>jsonplaceholder</code> 的 <code>todos</code> 接口作為示例，接口地址如下</p><blockquote><p><a href="https://jsonplaceholder.typicode.com/todos?callback=?">https://jsonplaceholder.typicode.com/todos?callback=?</a></p></blockquote><p><code>callback=?</code> 這個接在網址後面表示回調函數的名稱，也就是將你自己在客戶端定義的回調函數的函數名傳送給服務端，</p><p>服務端則會返回以你定義的回調函數名的方法，將獲取的 <code>JSON</code> 數據傳入這個方法完成回調，我們的回調函數名字叫 <code>cb</code>，那麼完整的接口地址就如下</p><blockquote><p><a href="https://jsonplaceholder.typicode.com/todos?callback=cb">https://jsonplaceholder.typicode.com/todos?callback=cb</a></p></blockquote><p>麼話不多說，我們來試下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>  <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span><span class=p>&gt;</span>
    <span class=kd>function</span> <span class=nx>cb</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=kd>function</span> <span class=nx>addScriptTag</span><span class=p>(</span><span class=nx>src</span><span class=p>)</span> <span class=p>{</span>
      <span class=kd>let</span> <span class=nx>script</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;script&#39;</span><span class=p>)</span>
      <span class=nx>script</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>,</span> <span class=s1>&#39;text/javascript&#39;</span><span class=p>)</span>
      <span class=nx>script</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>src</span>
      <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>script</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nb>window</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
      <span class=nx>addScriptTag</span><span class=p>(</span><span class=s1>&#39;https://jsonplaceholder.typicode.com/todos?callback=cb&#39;</span><span class=p>)</span>
    <span class=p>}</span>
  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>可以看到，頁面在加載完成後，輸出了接口返回的數據，這個時候我們再來看 <code>jQuery</code> 中的 <code>JSONP</code> 實現</p><ul><li>jQuery</li></ul><p>還是用上面的接口，我們來看 JQ 怎麼拿數據</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>  <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=nx>$</span><span class=p>.</span><span class=nx>ajax</span><span class=p>({</span>
      <span class=nx>url</span><span class=o>:</span> <span class=s1>&#39;https://jsonplaceholder.typicode.com/todos?callback=?&#39;</span><span class=p>,</span>
      <span class=nx>dataType</span><span class=o>:</span> <span class=s1>&#39;jsonp&#39;</span><span class=p>,</span>
      <span class=nx>jsonpCallback</span><span class=o>:</span> <span class=s1>&#39;cb&#39;</span><span class=p>,</span>
      <span class=nx>success</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span>
      <span class=p>},</span>
    <span class=p>})</span>
  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>可以看到，為了讓 <code>jQuery</code> 按照 <code>JSONP</code> 的方式訪問，<code>dataType</code> 字段設置為 <code>jsonp</code> ， <code>jsonpCallback</code> 屬性的作用就是自定義我們的回調方法名，其實內部和我們上面寫的差不多</p><h4 id=3-1-3-jsonp-vs-ajax>3.1.3. JSONP VS AJAX</h4><p>調用方式上</p><ul><li><code>AJAX</code> 和 <code>JSONP</code> 很像，都是請求 <code>url</code>，然後把服務器返回的數據進行處理</li><li>所以類 <code>JQuery</code> 的庫只是把 <code>JSONP</code> 作為 <code>AJAX</code> 請求的一種形式進行封裝，不要搞混</li></ul><p>核心原理上</p><ul><li><code>AJAX</code> 的核心是通過 <code>xmlHttpRequest</code> 獲取非本頁內容</li><li><code>JSONP</code> 的核心是動態添加 <code>script</code> 標籤調用服務器提供的 <code>JS</code> 腳本，後綴 <code>.json</code></li></ul><p>兩者區別上，</p><ul><li><code>AJAX</code> 不同域會報跨域錯誤，不過也可以通過服務端代理、<code>CORS</code> 等方式跨域，而 <code>JSONP</code> 沒有這個限制，同域不同域都可以</li><li><code>JSONP</code> 是一種方式或者說非強制性的協議，<code>AJAX</code> 也不一定非要用 <code>json</code> 格式來傳遞數據</li><li><code>JSONP</code> 只支持 <code>GET</code> 請求，<code>AJAX</code> 支持 <code>GET</code> 和 <code>POST</code></li></ul><h3 id=3-2-cors>3.2. CORS</h3><p><code>CORS</code> 需要瀏覽器和後端同時支持。 <code>IE 8</code> 和 <code>9</code> 需要通過 <code>XDomainRequest</code> 來實現。</p><p>瀏覽器會自動進行 <code>CORS</code> 通信，實現 <code>CORS</code> 通信的關鍵是後端 。 只要後端實現了 <code>CORS</code>，就實現了跨域。</p><p>服務端設置 <code>Access-Control-Allow-Origin</code> 就可以開啟 <code>CORS</code> 。</p><p>該屬性表示哪些域名可以訪問資源，如果設置通配符則表示所有網站都可以訪問資源。</p><p>雖然設置 <code>CORS</code> 和前端沒什麼關係，但是通過這種方式解決跨域問題的話，會在發送請求時出現兩種情況，分別為簡單請求和復雜請求。</p><h4 id=3-2-1-間單請求>3.2.1. 間單請求</h4><p>只要同時滿足以下兩大條件，就屬於簡單請求</p><ul><li><p>條件 1：使用下列方法之一：</p><ul><li><code>GET</code></li><li><code>HEAD</code></li><li><code>POST</code></li></ul></li><li><p>條件 2：<code>Content-Type</code> 的值僅限於下列三者之一：</p><ul><li><code>text/plain</code></li><li><code>multipart/form-data</code></li><li><code>application/x-www-form-urlencoded</code></li></ul></li></ul><p>請求中的任意 <code>XMLHttpRequestUpload</code> 對象均沒有註冊任何事件監聽器；</p><p><code>XMLHttpRequestUpload</code> 對象可以使用 <code>XMLHttpRequest.upload</code> 屬性訪問。</p><h4 id=3-2-2-複雜請求>3.2.2. 複雜請求</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></pre></td><td class=lntd><pre class=chroma>  不符合以上條件的請求就肯定是複雜請求了。

  複雜請求的 `CORS` 請求，會在正式通信之前，增加一次HTTP查詢請求，稱為 &#34;預檢&#34; 請求, 該請求是 `option` 方法的，通過該請求來知道服務端是否允許跨域請求。

  我們用 `PUT` 向後台請求時，屬於復雜請求，後台需做如下配置：

  ```javascript
      // 允許哪個方法訪問我
      res.setHeader(&#39;Access-Control-Allow-Methods&#39;, &#39;PUT&#39;)
      // 預檢的存活時間
      res.setHeader(&#39;Access-Control-Max-Age&#39;, 6)

      // OPTIONS 請求不做任何處理
      if (req.method === &#39;OPTIONS&#39;) {
          res.end()
      }
      // 定義後台返回的內容
      app.put(&#39;/getData&#39;, function(req, res) {
          console.log(req.headers)
          res.end(&#39;Hello&#39;)
      })
  ```

  接下來我們看下一個完整復雜請求的例子，並且介紹下CORS請求相關的字段

  ```html
      // index.html
      let xhr = new XMLHttpRequest()
      document.cookie = &#39;name=xiamen&#39; // cookie 不能跨域
      xhr.withCredentials = true // 前端設置是否帶 cookie
      xhr.open(&#39;PUT&#39;, &#39;http://localhost:4000/getData&#39;, true)
      xhr.setRequestHeader(&#39;name&#39;, &#39;xiamen&#39;)
      xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
              if ((xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) || xhr.status === 304) {
                  console.log(xhr.response)
                  //得到響應頭，後台需設置 Access-Control-Expose-Headers
                  console.log(xhr.getResponseHeader(&#39;name&#39;))
              }
          }
      }
      xhr.send()

  ```

  ```javascript
  //server1.js
  let express = require(&#39;express&#39;)
  let app = express()
  app.use(express.static(__dirname))
  app.listen(3000)
  複製代碼 //server2.js
  let express = require(&#39;express&#39;)
  let app = express()
  let whitList = [&#39;http://localhost:3000&#39;] //設置白名單
  app.use(function (req, res, next) {
    let origin = req.headers.origin
    if (whitList.includes(origin)) {
      // 設置哪個源可以訪問我
      res.setHeader(&#39;Access-Control-Allow-Origin&#39;, origin)
      // 允許攜帶哪個頭訪問我
      res.setHeader(&#39;Access-Control-Allow-Headers&#39;, &#39;name&#39;)
      // 允許哪個方法訪問我
      res.setHeader(&#39;Access-Control-Allow-Methods&#39;, &#39;PUT&#39;)
      // 允許攜帶cookie
      res.setHeader(&#39;Access-Control-Allow-Credentials&#39;, true)
      // 預檢的存活時間
      res.setHeader(&#39;Access-Control-Max-Age&#39;, 6)
      // 允許返回的頭
      res.setHeader(&#39;Access-Control-Expose-Headers&#39;, &#39;name&#39;)
      if (req.method === &#39;OPTIONS&#39;) {
        res.end() // OPTIONS請求不做任何處理
      }
    }
    next()
  })
  app.put(&#39;/getData&#39;, function (req, res) {
    console.log(req.headers)
    res.setHeader(&#39;name&#39;, &#39;jw&#39;) //返回一個響應頭，後台需設置
    res.end(&#39;Hello&#39;)
  })
  app.get(&#39;/getData&#39;, function (req, res) {
    console.log(req.headers)
    res.end(&#39;Hello&#39;)
  })
  app.use(express.static(__dirname))
  app.listen(4000)
  ```</pre></td></tr></table></div></div><p>上述代碼由 <code>http://localhost:3000/index.html</code> 向 <code>http://localhost:4000/</code> 跨域請求，正如我們上面所說的，後端是實現 <code>CORS</code> 通信的關鍵。</p><h3 id=3-3-postmessage>3.3. postMessage</h3><p><code>postMessage</code> 是 <code>HTML5</code> <code>XMLHttpRequest Level 2</code> 中的 API，且是為數不多可以跨域操作的 window 屬性之一，它可用於解決以下方面的問題：</p><ul><li>頁面和其打開的新窗口的數據傳遞</li><li>多窗口之間消息傳遞</li><li>頁面與嵌套的 iframe 消息傳遞</li><li>上面三個場景的跨域數據傳遞</li></ul><p><code>postMessage()</code>方法允許來自不同源的腳本採用異步方式進行有限的通信，可以實現跨文本檔、多窗口、跨域消息傳遞。</p><blockquote><p>otherWindow.postMessage(message, targetOrigin, [transfer]);</p></blockquote><ul><li>message: 將要發送到其他 window 的數據。</li><li>targetOrigin:通過窗口的 origin 屬性來指定哪些窗口能接收到消息事件，其值可以是字符串&rdquo;*&ldquo;（表示無限制）或者一個 URI。在發送消息的時候，如果目標窗口的協議、主機地址或端口這三者的任意一項不匹配 targetOrigin 提供的值，那麼消息就不會被發送；只有三者完全匹配，消息才會被發送。</li><li>transfer(可選)：是一串和 message 同時傳遞的 Transferable 對象. 這些對象的所有權將被轉移給消息的接收方，而發送一方將不再保有所有權。</li></ul><p>接下來我們看個例子：</p><p><code>http://localhost:3000/a.html</code> 頁面向 <code>http://localhost:4000/b.html</code> 傳遞 &lsquo;Hello&rsquo; , 然後後者傳回&rdquo;Hi&rdquo;。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>  // a.html
  <span class=p>&lt;</span><span class=nt>iframe</span>
    <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://localhost:4000/b.html&#34;</span>
    <span class=na>frameborder</span><span class=o>=</span><span class=s>&#34;0&#34;</span>
    <span class=na>id</span><span class=o>=</span><span class=s>&#34;frame&#34;</span>
    <span class=na>onload</span><span class=o>=</span><span class=s>&#34;load()&#34;</span>
  <span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
  //等它加載完觸發一個事件, 內嵌在http://localhost:3000/a.html
  <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=kd>function</span> <span class=nx>load</span><span class=p>()</span> <span class=p>{</span>
      <span class=kd>let</span> <span class=nx>frame</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;frame&#39;</span><span class=p>)</span>
      <span class=nx>frame</span><span class=p>.</span><span class=nx>contentWindow</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s1>&#39;Hello&#39;</span><span class=p>,</span> <span class=s1>&#39;http://localhost:4000&#39;</span><span class=p>)</span> <span class=c1>//發送數據
</span><span class=c1></span>      <span class=nb>window</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>//接受返回數據
</span><span class=c1></span>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=c1>//Hi
</span><span class=c1></span>      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript>  <span class=c1>// b.html
</span><span class=c1></span>  <span class=nb>window</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=c1>//Hello
</span><span class=c1></span>    <span class=nx>e</span><span class=p>.</span><span class=nx>source</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s1>&#39;Hi&#39;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>origin</span><span class=p>)</span>
  <span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=3-4-webscoket>3.4. WebScoket</h3><p>客戶端：<a href=http://www.example.com/a.html>http://www.example.com/a.html</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/socket.io/socket.io.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=kd>let</span> <span class=nx>socket</span> <span class=o>=</span> <span class=nx>io</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=s1>&#39;ws://www.example1.com:3000&#39;</span><span class=p>)</span>

  <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;my event&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=c1>// { hello: &#39;world&#39; }
</span><span class=c1></span>    <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;my other event&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>my</span><span class=o>:</span> <span class=s1>&#39;data&#39;</span> <span class=p>})</span>
  <span class=p>})</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>服務端：ws://www.example1.com:3000</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-javascript data-lang=javascript><span class=k>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>).</span><span class=nx>createServer</span><span class=p>()</span>
<span class=k>const</span> <span class=nx>io</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;socket.io&#39;</span><span class=p>)(</span><span class=nx>app</span><span class=p>)</span>

<span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>

<span class=nx>io</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>socket</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;my event&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>hello</span><span class=o>:</span> <span class=s1>&#39;world&#39;</span> <span class=p>})</span>

  <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;my other event&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=c1>// { my: &#39;data&#39; }
</span><span class=c1></span>  <span class=p>})</span>
<span class=p>})</span>
</code></pre></td></tr></table></div></div><h3 id=3-5-nginx-反向代理>3.5. Nginx 反向代理</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1>#proxy</span>
    server <span class=o>{</span>
        listen       <span class=m>80</span><span class=p>;</span>
        server_name  www.example.com<span class=p>;</span>

        location / <span class=o>{</span>
            proxy_pass   http://www.example2.com:8080<span class=p>;</span>  <span class=c1>#反向代理</span>
            proxy_cookie_domain www.example2.com www.example.com<span class=p>;</span> <span class=c1>#修改cookie里域名</span>
            index  index.html index.htm<span class=p>;</span>
            add_header Access-Control-Allow-Origin http://www.example.com<span class=p>;</span>  <span class=c1>#當前端只跨域不帶cookie時，可為*</span>
            add_header Access-Control-Allow-Credentials true<span class=p>;</span>
        <span class=o>}</span>
    <span class=o>}</span></code></pre></td></tr></table></div></div><h3 id=3-6-window-name-iframe>3.6. window.name + iframe</h3><p><code>window.name</code> 屬性的獨特之處：<code>name</code> 值在不同的頁面（甚至不同域名）加載後依舊存在，並且可以支持非常長的 name 值（2MB）。</p><p>其中 <code>a.html</code> 和 <code>b.html</code> 是同域的，都是 <code>http://localhost:3000</code> , 而 <code>c.html</code>是 <code>http://localhost:4000</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>// a.html(http://localhost:3000/b.html)
<span class=p>&lt;</span><span class=nt>iframe</span>
  <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://localhost:4000/c.html&#34;</span>
  <span class=na>frameborder</span><span class=o>=</span><span class=s>&#34;0&#34;</span>
  <span class=na>onload</span><span class=o>=</span><span class=s>&#34;load()&#34;</span>
  <span class=na>id</span><span class=o>=</span><span class=s>&#34;iframe&#34;</span>
<span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>

<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=kd>let</span> <span class=nx>first</span> <span class=o>=</span> <span class=kc>true</span>
  <span class=c1>// onload事件會觸發2次，第1次加載跨域頁，並留存數據於window.name
</span><span class=c1></span>  <span class=kd>function</span> <span class=nx>load</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=nx>first</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// 第1次onload(跨域頁)成功後，切換到同域代理頁面
</span><span class=c1></span>      <span class=kd>let</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>)</span>
      <span class=nx>iframe</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;http://localhost:3000/b.html&#39;</span>
      <span class=nx>first</span> <span class=o>=</span> <span class=kc>false</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=c1>// 第2次onload(同域b.html頁)成功後，讀取同域window.name中數據
</span><span class=c1></span>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>iframe</span><span class=p>.</span><span class=nx>contentWindow</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>b.html 為中間代理頁，與 a.html 同域，內容為空。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>// c.html(http://localhost:4000/c.html)
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=nb>window</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=s1>&#39;Hello&#39;</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><p>總結：通過 <code>iframe</code> 的 <code>src</code> 屬性由外域轉向本地域，跨域數據即由 <code>iframe</code> 的 <code>window.name</code> 從外域傳遞到本地域。</p><p>個就巧妙地繞過了瀏覽器的跨域訪問限制，但同時它又是安全操作。</p><h3 id=3-7-location-hash-iframe>3.7. location.hash + iframe</h3><p>實現原理： <code>a.html</code> 欲與 <code>c.html</code> 跨域相互通信，通過中間頁 <code>b.html</code> 來實現。</p><p>三個頁面，不同域之間利用 <code>iframe</code> 的 <code>location.hash</code> 傳值，相同域之間直接 js 訪問來通信。</p><p>具體實現步驟：一開始 <code>a.html</code> 給 <code>c.html</code> 傳一個 hash 值，然後 <code>c.html</code> 收到 <code>hash</code> 值後，再把 <code>hash</code> 值傳遞給 <code>b.html</code>，最後 <code>b.html</code> 將結果放到 <code>a.html</code> 的 <code>hash</code> 值中。</p><p>同樣的，<code>a.html</code> 和 <code>b.html</code> 是同域的，都是 <code>http://localhost:3000</code> 而 <code>c.html</code>是 <code>http://localhost:4000</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>// a.html
<span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://localhost:4000/c.html#iloveyou&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=nb>window</span><span class=p>.</span><span class=nx>onhashchange</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=c1>//檢測hash的變化
</span><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>location</span><span class=p>.</span><span class=nx>hash</span><span class=p>)</span>
  <span class=p>}</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>// b.html
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=nb>window</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>hash</span> <span class=o>=</span> <span class=nx>location</span><span class=p>.</span><span class=nx>hash</span>
  <span class=c1>//b.html將結果放到a.html的hash值中，b.html可通過parent.parent訪問a.html頁面
</span><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>// c.html
<span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>location</span><span class=p>.</span><span class=nx>hash</span><span class=p>)</span>
  <span class=kd>let</span> <span class=nx>iframe</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>)</span>
  <span class=nx>iframe</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;http://localhost:3000/b.html#idontloveyou&#39;</span>
  <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>iframe</span><span class=p>)</span>
  <span class=nb>document</span><span class=p>.</span><span class=nx>domain</span> <span class=o>+</span> <span class=nx>iframe</span>
<span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><h3 id=3-8-document-domain-iframe>3.8. document.domain + iframe</h3><p>該方式只能用於二級域名相同的情況下，比如 <code>a.test.com</code> 和 <code>b.test.com</code> 適用於該方式。</p><p>只需要給頁面添加 <code>document.domain ='test.com'</code> 表示二級域名都相同就可以實現跨域。</p><p>實現原理：兩個頁面都通過 <code>js</code> 強制設置 <code>document.domain</code> 為基礎主域，就實現了同域。</p><p>我們看個例子：頁面 <code>a.test.com:3000/a.html</code> 獲取頁面 <code>b.test.com:3000/b.html</code> 中 <code>a</code> 的值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>// a.html
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
  helloa
  <span class=p>&lt;</span><span class=nt>iframe</span>
    <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://b.test.com:3000/b.html&#34;</span>
    <span class=na>frameborder</span><span class=o>=</span><span class=s>&#34;0&#34;</span>
    <span class=na>onload</span><span class=o>=</span><span class=s>&#34;load()&#34;</span>
    <span class=na>id</span><span class=o>=</span><span class=s>&#34;frame&#34;</span>
  <span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
  <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=nb>document</span><span class=p>.</span><span class=nx>domain</span> <span class=o>=</span> <span class=s1>&#39;test.com&#39;</span>
    <span class=kd>function</span> <span class=nx>load</span><span class=p>()</span> <span class=p>{</span>
      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>frame</span><span class=p>.</span><span class=nx>contentWindow</span><span class=p>.</span><span class=nx>a</span><span class=p>)</span>
    <span class=p>}</span>
  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-html data-lang=html><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-html data-lang=html>// b.html
<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
  hellob
  <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
    <span class=nb>document</span><span class=p>.</span><span class=nx>domain</span> <span class=o>=</span> <span class=s1>&#39;test.com&#39;</span>
    <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>100</span>
  <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span></code></pre></td></tr></table></div></div><h2 id=4-参考文章>4. 参考文章</h2><ul><li><a href=http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html>浏览器同源政策及其规避方法 - 阮一峰</a></li><li><a href=http://www.ruanyifeng.com/blog/2016/04/cors.html>跨域资源共享 CORS 详解 - 阮一峰</a></li><li><a href=https://juejin.im/post/5f0b3e136fb9a07eaa40bc0d#heading-0>你真的了解跨域吗 - 掘金</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>Feng-Chi</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2020-07-14</span></p><p class=copyright-item><span class=item-title>許可協議</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/cors/>CORS</a>
<a href=/tags/web/>web</a></div><nav class=post-nav><a class=prev href=/post/2020/07/30/clean-code-php/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Clean Code 系列 - PHP</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/2020/07/nginx-setting-record/><span class="next-text nav-default">Nginx 相關設定</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=comments-gitment></div><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.min.css crossorigin=anonymous><script src=https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.min.js crossorigin=anonymous></script><script type=text/javascript>var gitment=new Gitment({id:'2020-07-14 08:51:19 \x2b0800 \x2b0800',title:'關於 Web 跨域相關紀錄',link:decodeURI(location.href),desc:'\x3ch2 id=\x22前言\x22\x3e前言\x3c\/h2\x3e\n\n\x3cp\x3e前段時間公司同事出現了跨域問題 , 雖然我知道了大略的解決方案 , 但是說實在的真實真實的跨域知識及領域 ,\x3c\/p\x3e\n\n\x3cp\x3e不是了解得很透徹 , 趁這個機會好好查一下文章記錄下來\x3c\/p\x3e',owner:'holmeslin',repo:'holmeslin.github.io',oauth:{client_id:'05f414719d56905a1d49',client_secret:'7d76251defef60a6cc6aa55627c7c2f51b7429b0'}});gitment.render('comments-gitment');</script><noscript>Please enable JavaScript to view the <a href=https://github.com/imsun/gitment>comments powered by gitment.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:holmes.lin@gmail.com class="iconfont icon-email" title=email></a><a href=https://facebook.com/fengchilin class="iconfont icon-facebook" title=facebook></a><a href=https://www.linkedin.com/in/holmeslin/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/holmeslin class="iconfont icon-github" title=github></a><a href=https://holmeslin.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2019 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Feng-Chi</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js></script></body></html>